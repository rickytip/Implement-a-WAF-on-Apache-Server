# Implement-a-WAF-on-Apache-Server
# Scenario: <br>
HTTP servers, such as Apache, can be easily deployed with just a few commands. In its default configuratioin, Apache is stable and reliable and offers many useful features. Like other HTTP servers, Apache is highly customizable and its functionality can be through the use of modules. There are many configuration settings that should be adjusted to ensure secure operation, and those settings should be carefully reviewed and implemented in accordance with organizational policy, regulatory and/or contractual requirements. A common practice designed to improve the security stance of an HTTP server is to implement a web application firewall (WAF).

1. Launch a terminal window by clicking the shortcut to Terminal located on the Ubuntu Dock.
Once Terminal is running, install the Apache web server by entering the following command:
      - sudo apt update && sudo apt install apache2 -y and then hit Enter.
      
2. After the installation completes, verify that Apache has been successfully installed by starting the Firefox web browser and navigating to http://localhost. A shortcut to the Firefox browser is located on the Ubuntu Dock.

The following Default web page should appear if the installation was successful.

![image](https://user-images.githubusercontent.com/37230931/226136880-5c92d7a6-6a06-4d49-bd96-375f93bf0f9e.png)

Close Firefox after viewing the Apache2 Ubuntu Default Page, acknowledging any prompts that may appear regarding multiple tabs.

# Observe Default Error Logging.
- Apache provides an error log that can be useful for troubleshooting but, in its default   configuration, provides limited information regarding observed attacks.

- In this section, we shall simulate attack traffic by scanning the web server with the nikto tool and then observe information contained in the Apache error log.

3. Review the IP address asigned to the Ubuntu VM by typing ip a | grep -w inet (and then hit enter) into the Terminal. The IP address will be needed in a later step

4. Use the tail command to provide a realtime view of the contents of the Apache error log by typing tail -f /var/log/apache2/error.log and then hit Enter.

5. Switch to the Kali Linux VM

6. Launch a Terminal window by clicking the Terminal Emulator shortcut located on the launcher

7. Start a nikto scan by typing nikto -h followed by the IP address of the Ubuntu VM obtained previously. If you are prompted with a message regarding "Portions of the server's headers are not in the database" hit n and then enter.  

<img width="468" alt="image" src="https://user-images.githubusercontent.com/37230931/226142462-d31aea4c-1866-48c8-a9bc-d04e9e441eb6.png">

8. Switch back to the Ubuntu Linux
    - The terminal window should be displaying new entries in the Apache error log generated by the nikto scan.
    
    - Notice the following entries:
  "Invalid URI in request GET /htdocs/../../../../../../../../../../../etc/passwd"
  and
  "Invalid URI in request GET      /%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd" and other similar entries.
  
 
 # Install and Configure ModSecurity and OWASP CRS
 
Now that we have observered the default characteristics of Apache, we can proceed to install and configure the ModSecurity module.
In this section, we shall download and install ModSecurity and then configure it to use OWASP Core Rule Set (CRS).

9. Close the Apache log by typing ctrl-c into the Terminal

10. Install ModSecurity by typing sudo apt install libapache2-mod-security2 -y and then hit enter. Enter the password Pa$$w0rd when prompted.

11. Rename the default modsecurity configuration file by typing sudo mv /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf and then hit enter.

12. Rename the default core rule set configuration file. We will be replacing it with the OWASP CRS in the next steps. Type sudo mv /usr/share/modsecurity-crs /usr/share/modsecurity-crs.orig to rename the default CRS and then hit enter.

13. Next, we must install git in order to be able to obtain the OWASP CRS from the Official OWASP CRS code repository. Tpye sudo apt install git -y and then hit enter to install git.

14. Download a copy of the OWASP CRS and save it to the /usr/share directory. Type sudo git clone https://github.com/coreruleset/coreruleset.git /usr/share/modsecurity-crs and then hit enter.

15. Copy the example CRS setup configuration file so it can be used by the Modsec module. This configuration contains the rules used by ModSecurity. Type sudo cp /usr/share/modsecurity-crs/crs-setup.conf.example /usr/share/modsecurity-crs/crs-setup.conf and then hit enter.

 16. Edit the security2.conf file so that the ModSecurity module will be used by Apache. The configuration file can be edited using nano by typing sudo nano /etc/apache2/mods-enabled/security2.conf and then hit enter. Use the keyboard arrow keys to navaigate to line containing < /IfModule > and then hit enter to make space for two new entries in the configuration.
 
 17. Use the keyboard arrow keys to navigate back to the blank space just created and type the following entry IncludeOptional /usr/share/modsecurity-crs/*.conf then hit enter.

18. On the next line, type the following IncludeOptional /usr/share/modsecurity-crs/rules/*.conf. When finished, the configuration file should look like the one provided in this image: 

![image](https://user-images.githubusercontent.com/37230931/226150165-0acb4df3-7c04-4378-b948-8776dfb44c57.png)

19. Enter ctrl-x and then enter y followed by enter in order to save the changes to the file.

20. Reload Apache to force it to read the updated configuration by typing sudo /etc/init.d/apache2 force-reload and hit enter. Type the password Pa$$w0rd if prompted.

21. Use the tail command to provide a realtime view of the contents of the Apache error log by typing tail -f /var/log/apache2/error.log and then hit Enter. We shall review the log again in the next section.

      Congratulations! You have just enabled the ModSecurity WAF for Apache. Now let's see the results…
      
 # Observe New Functionality Provided by ModSecurity and OWASP CRS    
 
 In the previous section, the ModSecurity module was added to Apache and then configured to use OWASP CRS rules. Now that the ModSecurity module is ready, re-running a nikto scan will result in new behavior. The added functionality can be observed by reviewing the error log - much, much more information will be contained in it as Apache is now able to to more accurately identify attack patterns.

22. Switch to the Kali Linux VM 

23. If not already open, launch a Terminal window by clicking the Terminal Emulator shortcut located on the launcher.

24. Start a nikto scan by typing nikto -h followed by the IP address of the Ubuntu VM obtained previously. If you are prompted with a message regarding "Portions of the server's headers are not in the database" hit n and then enter. 

<img width="468" alt="image" src="https://user-images.githubusercontent.com/37230931/226150803-22478136-3486-4ef1-b236-85afc78c8813.png">

25. Switch back to the Ubuntu Linux VM while the scan is still running.
      The terminal window should be displaying numerous new entries in the Apache error         log generated by the nikto scan. (If the log is not still open from the previous           section, open it using the command tail -f /var/log/apache2/error.log)

Notice that the error log contains many specific details regarding the type of attacks being observed, the source of the attack, scoring information, rule matches and many more fields. This information is available now as a result of adding the ModSecurity module and configuring OWASP CRS rules.

The information contained in this log can be used by operational security tools, such as a SIEM, to obtain far greater visibility into attacks.
![image](https://user-images.githubusercontent.com/37230931/226150910-f3ca04fc-271a-4765-983a-a027e7ff6a70.png)
